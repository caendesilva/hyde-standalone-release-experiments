#!/usr/bin/env php
<?php

/**
 * This is the main entry point for the global Hyde binary,
 * and is what runs when you run `hyde` from the command line.
 *
 * The binary can be used in three ways:
 * - Installation mode: Allows new Hyde projects to be created
 * - Anonymous mode: Uses the built-in scaffolding to allow Hyde to be used
 *                   without installation in a directory with just source files.
 *                   It includes the installation mode.
 * - Proxy mode: Defers to the Hyde installation in the current directory.
 */

// Define working directory
define('HYDE_WORKING_DIR', getcwd());

// Determine the mode to run in
define('HYDE_MODE', (function () {
    // If the current directory contains a Hyde binary, run in proxy mode
    if (file_exists(HYDE_WORKING_DIR . '/hyde')) {
        return 'proxy';
    }

    // Otherwise, run in anonymous mode
    return 'anonymous';
})());

return match (HYDE_MODE) {
    'proxy' => require HYDE_WORKING_DIR . '/hyde',
    'anonymous' => (function() {
        // Bootstrap the Phar application

        // To allow the binary to run anywhere, we define a temporary directory
        // that Laravel can use to store the compiled views and other cache files.
        define('HYDE_TEMP_DIR', sprintf('%s/hyde-%s', sys_get_temp_dir(), md5(HYDE_WORKING_DIR)));

        // Register the autoloader
        $autoloader = require file_exists(__DIR__.'/../vendor/autoload.php') ?  __DIR__.'/../vendor/autoload.php' : __DIR__.'/../../autoload.php';

        // Create the application
        $app = require_once __DIR__.'/../app/anonymous-bootstrap.php';
    })(),
};
